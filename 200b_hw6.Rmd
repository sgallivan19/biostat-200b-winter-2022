---
title: "200b_homework6"
author: "Seamus Gallivan"
date: "2/20/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Read in senic data

```{r}
library(leaps)
library(olsrr)
library(car)
library(MASS)
library(tidyverse)
senic <- read_csv("/Users/seamusgallivan/Documents/ucla/200B/data/senic.csv")
```

## Question 2 

Model regressing loglength on xray, census and age

```{r}
#create log transformed length 
senic <- senic %>% 
  mutate(loglength = log(length))
#model 
model1 <- lm(loglength ~ xray + census + age, data = senic)
summary(model1)
```

**Part A**

Leverage, studentized residuals and Cook's D plots

```{r}
#leverage plots
leveragePlots(model1)
#studentized residual 
stud_resids <- as_tibble(studres(model1))
#create row index column in stud_resids to help with join 
stud_resids$index <- seq.int(nrow(stud_resids))
#left join 
senic <- senic %>% 
  left_join(stud_resids, by = c("id" = "index"))
#rename value to studres 
senic <- rename(senic, sres_value = value)
#sres plot 
sres <- ggplot(senic, aes(id, sres_value))
sres + geom_point()
#Cook's D
ols_plot_cooksd_bar(model1)
```

**Part B**

```{r}
fivenum(senic$loglength)
fivenum(senic$xray)
fivenum(senic$census)
fivenum(senic$age)

arrange(senic, desc(loglength))
```

Hospitals 47 and 112 have the highest Cook's D values.
Based on the plots, they have large leverage values and studentized residual values of 2 or greater. In comparison to their five number (min, 25th percentile, median, 75th percentile, max) summary, they have above 75th percentile log(length) values, above 50th percentile xray values, above 75th percentile census values and above 75th percentile age values. Most notably, hospital 47 has the largest Log(length) value and hospital 112 has the second highest. 

**Part C**

```{r}
#create reduced df senic2 
senic2 <- senic %>%  
  filter(!id %in% c(47, 112))
#reduced model 
reduced_model <- lm(loglength ~ xray + census + age, data = senic2)
summary(reduced_model)
#compare to full 
summary(model1)
anova(reduced_model)
anova(model1)
```

regression coefficients: All regression coefficients are less in the reduced model except for the intercept.
p-values: p-values are more significant for the full model. 
MSE: The MSE is greater for the full model.

**Part D**

```{r}
#component + residual plot 
crPlots(model1)
#log transform census??
senic <- senic %>% 
  mutate(logcensus = log(census))
model2 <- lm(loglength ~ age + xray + logcensus, data = senic)
summary(model2)
```

## Question 3 

**Part A** 
```{r}
#create nurse/patient ratio variable 
senic <- senic %>% 
  mutate(npr = nurses / census)
```

**Part B**

```{r}
#distribution of region, beds, services, medsch, xray, length, npr 
hist(senic$region)
hist(senic$beds)
hist(senic$svcs)
hist(senic$msch)
hist(senic$xray)
hist(senic$length)
hist(senic$npr)
```

Variables 'length' and 'beds' are positively skewed.

```{r}
senic <- senic %>% 
  mutate(loglength = log(length), logbeds = log(beds))
```

**Part C**

Best 3 models for each model size + Cp and BIC values. 

```{r}
#best subset model 
bestsub.model <- regsubsets(risk ~ region + logbeds + svcs + msch + xray +
                              loglength + npr, 
                            data = senic, nbest = 3, nvmax = 7)

summary(bestsub.model)
#Consider Cp, AIC
  cbind( 
    Cp     = summary(bestsub.model)$cp,
    BIC    =summary(bestsub.model)$bic
)
```

The 5 best models are the same based on either Cp or BIC. Let's now look at the AIC for those 5 models.  

```{r}
modelc1 <- lm(risk ~ loglength + npr + logbeds + xray, data = senic)
modelc2 <- lm(risk ~ loglength + npr + logbeds + xray + region, data = senic)
modelc3 <- lm(risk ~ loglength + npr + logbeds + xray + msch, data = senic)
modelc4 <- lm(risk ~ loglength + npr + logbeds + xray + svcs, data = senic)
modelc5 <- lm(risk ~ loglength + npr + logbeds + xray + region + msch, 
              data = senic)
AIC(modelc1)
AIC(modelc2)
AIC(modelc3)
AIC(modelc4)
AIC(modelc5)
```

The top 3 models vary depending on whether we use AIC, BIC or Cp. I am going to rank my models using AIC since it is the most happy medium between the 3 measurements.

**Part D**

| Vars                                                   | AIC     | BIC      | Cp       |
|:------------------------------------------------------:|:-------:|:--------:|:--------:|
|loglength + npr + logbeds + xray + region               |322.4082 |-49.19952 |4.698585  |
|loglength + npr + logbeds + xray                        |322.6556 |-51.67953 |4.821788  |
|loglength + npr + logbeds + xray + msch                 |324.0364 |-47.57131 |6.232614  |
|loglength + npr + logbeds + xray + svcs                 |324.588  |-47.01979 |6.757264  |     
|loglength + npr + logbeds + xray + region + msch        |323.7053 |-45.17509 |6.043083  |
